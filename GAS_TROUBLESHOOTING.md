# GAS 웹 앱 연결 문제 해결 가이드

## 증상
- `net::ERR_FAILED` 오류
- `TypeError: Failed to fetch` 오류
- `CORS policy: No 'Access-Control-Allow-Origin' header` 오류
- 백업 기능 실패
- Gemini API 호출 실패
- **GET 요청은 성공하지만 POST 요청이 실패하는 경우**

---

## 🔴 CORS 오류의 근본 원인

### 중요한 사실:
**Google Apps Script의 `ContentService.setHeaders()`는 존재하지 않는 메서드입니다!**

많은 튜토리얼에서 CORS 헤더를 직접 설정하라고 안내하지만, 이는 잘못된 정보입니다.
GAS 웹 앱에서 CORS를 처리하는 올바른 방법은:

✅ **웹 앱을 "모든 사용자(Anyone)"로 배포하면 CORS가 자동으로 처리됩니다!**

---

## ⚠️ 중요: POST 요청 실패 시 확인 사항

**GET 요청은 성공하지만 POST 요청이 실패하는 경우**, 가장 가능성 높은 원인은 **GAS 웹 앱 배포 설정**입니다.

### 즉시 확인할 사항:

1. [Google Apps Script 편집기](https://script.google.com/) 접속
2. **"배포"** → **"배포 관리"** 클릭
3. 기존 배포 옆의 **연필 아이콘** (편집) 클릭
4. **"액세스 권한"** 확인:
   - ❌ **"나"**로만 설정되어 있으면 → 외부에서 POST 요청 시 CORS 오류 발생!
   - ✅ **"모든 사용자"**로 변경 필요
5. **"버전"**에서 **"새 버전"** 선택
6. **"배포"** 클릭

**참고:** GET 요청은 "나"로 설정되어 있어도 작동할 수 있지만, POST 요청은 반드시 "모든 사용자" 권한이 필요합니다.

## 해결 방법

### 1단계: GAS 웹 앱 배포 확인

1. [Google Apps Script 편집기](https://script.google.com/) 접속
2. 해당 프로젝트 열기
3. **"배포"** → **"배포 관리"** 클릭
4. 다음 확인:
   - ✅ 웹 앱이 배포되어 있는지
   - ✅ **"액세스 권한"**이 **"모든 사용자"** 또는 **"나"**로 설정되어 있는지
   - ✅ **"실행 대상"**이 **"나"**로 설정되어 있는지
   - ✅ 웹 앱 URL이 활성 상태인지

### 2단계: 웹 앱 재배포 (필요시)

배포 설정이 올바르지 않으면:

1. **"배포"** → **"배포 관리"** 클릭
2. 기존 배포 옆의 **연필 아이콘** (편집) 클릭
3. 다음 설정 확인/변경:
   - **설명**: "PageGenie API Proxy" (선택사항)
   - **실행 대상**: **"나"** ⚠️ 중요
   - **액세스 권한**: **"모든 사용자"** 또는 **"나"**
4. **"새 버전"** 선택
5. **"배포"** 클릭
6. **웹 앱 URL 복사** (변경되지 않을 수 있음)

### 3단계: GAS URL 직접 테스트

브라우저에서 GAS URL을 직접 열어보기:

```
https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec
```

**정상 작동 시:**
- "✅ PageGenie API" 메시지가 표시됨
- "✅ GEMINI_API_KEY가 설정되어 있습니다." 메시지 표시

**오류 발생 시:**
- "권한이 필요합니다" → 권한 승인 필요
- "404 Not Found" → 배포가 안 되어 있음
- 빈 페이지 → 코드 오류 가능성

### 4단계: 애플리케이션 설정 확인

1. 애플리케이션 실행
2. 우측 상단 **⚙️ 설정** 아이콘 클릭
3. **"구글 시트 연동"** 탭 선택
4. **"Google Apps Script (GAS) Web App URL"** 필드 확인:
   - URL이 올바르게 입력되었는지
   - URL 끝에 `/exec`가 있는지
   - 공백이나 잘못된 문자가 없는지
5. **"설정 저장하기"** 클릭

### 5단계: 브라우저 콘솔 확인

1. 브라우저에서 **F12** 키 누르기
2. **"Console"** 탭 선택
3. 다음 로그 확인:
   - `[Gemini Service]` 로그
   - `[Backup]` 로그
   - 에러 메시지

### 6단계: 네트워크 탭 확인

1. 브라우저에서 **F12** 키 누르기
2. **"Network"** 탭 선택
3. 애플리케이션에서 기능 사용 시도
4. GAS URL로의 요청 확인:
   - 요청이 보내졌는지
   - 응답 상태 코드 (200, 404, 500 등)
   - CORS 오류가 있는지

## 일반적인 문제와 해결책

### 문제 1: "액세스 권한"이 "나"로만 설정됨
**해결:** "배포 관리"에서 "액세스 권한"을 "모든 사용자"로 변경

### 문제 2: GAS URL이 기본 데모 URL과 동일
**해결:** 설정에서 개인 GAS URL을 입력해야 함

### 문제 3: CORS 오류
**해결:** 
- ⚠️ GAS에서는 `setHeaders()`로 CORS 헤더를 설정할 수 없습니다!
- ✅ 웹 앱을 **"모든 사용자(Anyone)"**로 배포하면 CORS가 자동 처리됩니다.
- 반드시 **새 버전**으로 재배포해야 합니다.

### 문제 4: 타임아웃 오류
**해결:**
- 네트워크 연결 확인
- GAS 실행 시간 제한 (6분) 확인
- 요청 데이터 크기 확인

## 권한 테스트

GAS 편집기에서 다음 함수들을 실행하여 권한 확인:

1. **`testPermissions()`** - 모든 권한 테스트
2. **`testSheetsPermission()`** - Google Sheets 권한 테스트
3. **`testDrivePermission()`** - Google Drive 권한 테스트

실행 방법:
1. GAS 편집기에서 함수 선택 드롭다운 클릭
2. 함수 선택
3. 실행 버튼(▶️) 클릭
4. 권한 승인 팝업이 나타나면 "허용" 클릭

## 추가 확인 사항

- ✅ GAS 코드가 최신 버전인지 확인
- ✅ `GEMINI_API_KEY`가 스크립트 속성에 설정되어 있는지 확인
- ✅ 인터넷 연결이 정상인지 확인
- ✅ 방화벽이나 보안 소프트웨어가 차단하지 않는지 확인

## 여전히 문제가 발생하는 경우

1. 브라우저 콘솔의 전체 에러 메시지 캡처
2. GAS 실행 로그 확인 (편집기 → 실행 → 실행 로그)
3. Network 탭의 요청/응답 상세 정보 확인
4. 위 정보를 함께 공유해주시면 더 정확한 진단이 가능합니다.

